<!doctype html>
<html lang="es" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>The Archive</title>
  <link rel="icon" href="biblioteca.svg" type="image/svg+xml">
  <!-- Fallbacks: browsers will use PNG/ICO if available -->
  <link rel="icon" href="favicon-256.png" sizes="256x256" type="image/png">
  <link rel="shortcut icon" href="favicon.ico" type="image/x-icon">
  <meta name="color-scheme" content="light dark" />
  <style>
    /* Design tokens */
    :root {
      --radius: 12px;
      --space-1: .25rem; --space-2: .5rem; --space-3: .75rem; --space-4: 1rem; --space-5: 1.5rem; --space-6: 2rem;
      --shadow-1: 0 1px 2px rgba(0,0,0,.06), 0 8px 24px rgba(0,0,0,.08);
      --font-ui: system-ui, -apple-system, "SF Pro Text", Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      --maxw: 1220px;
    }
    :root[data-theme="light"] {
      --bg: #f5f5f7;
      --panel: #ffffffcc;            /* translucent for glass effect */
      --panel-solid: #ffffff;
      --elev: #ffffff;
      --fg: #0f172a;
      --muted: #475569;
      --line: #e5e7eb;
      --accent: #0a84ff;            /* apple blue */
      --accent-fg: #ffffff;
      --chip: #f1f5f9;
      --chip-fg: #334155;
      --kbd-bg:#f8fafc; --kbd-fg:#334155; --kbd-br:#e2e8f0;
    }
    :root[data-theme="dark"] {
      --bg: #0d0f14;
      --panel: #0f172acc;
      --panel-solid: #0f172a;
      --elev: #121826;
      --fg: #e6edf5;
      --muted: #9aa8bb;
      --line: #1f2a40;
      --accent: #0a84ff;
      --accent-fg: #08111f;
      --chip: #111a2f;
      --chip-fg: #b8c6d9;
      --kbd-bg:#0b1220; --kbd-fg:#cbd5e1; --kbd-br:#1f2a40;
    }

    /* Base */
    html, body { 
      height: 100%; 
      margin: 0; 
      padding: 0; 
      overflow-x: hidden; /* Solo prevenir scroll horizontal */
    }
    body {
      background: var(--bg); color: var(--fg); font-family: var(--font-ui);
      -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale;
      text-rendering: optimizeLegibility;
      display: flex; 
      flex-direction: column; 
      min-height: 100vh; /* Usar vh en lugar de svh para mejor compatibilidad */
    }
    .wrap { max-width: var(--maxw); margin: 0 auto; padding: 0 var(--space-4); }

    /* Glass nav */
    header {
      position: sticky; top:0; z-index:10;
      backdrop-filter: saturate(160%) blur(16px);
      -webkit-backdrop-filter: saturate(160%) blur(16px);
      background: var(--panel);
      border-bottom: 1px solid color-mix(in oklab, var(--panel-solid) 70%, var(--line));
    }
    .nav {
      display:flex; align-items:center; gap: var(--space-4); padding: .9rem 0;
    }
    .brand {
      display:flex; align-items:center; gap:.75rem; font-weight:700; letter-spacing:.2px; font-size:1.1rem;
    }
  .logo { width: 28px; height: 28px; border-radius: 8px; display:block; object-fit:contain; }
    .toolbar { margin-left:auto; display:flex; align-items:center; gap:.6rem; }

    /* Segmented controls */
    .seg {
      display:flex; gap:.25rem; background: color-mix(in oklab, var(--panel-solid) 85%, transparent);
      color: var(--fg); padding:.25rem; border-radius: 999px; align-items:center;
      border: 1px solid var(--line);
    }
    .seg button, .seg select {
      background: transparent; color: inherit; border: 0; padding:.45rem .75rem; border-radius: 999px;
      font: inherit; cursor: pointer; line-height: 1;
    }
    .seg button.active { background: var(--accent); color: var(--accent-fg); box-shadow: 0 1px 0 rgba(0,0,0,.1) inset; }
    .seg select { appearance:none; padding-right: 1.8rem; position: relative; }
    .seg .chev { margin-left:-1.4rem; pointer-events:none; opacity:.55; }

    /* Filters row */
    .filters {
      display:flex; gap:.5rem; flex-wrap: wrap; padding: .9rem 0 1rem;
      align-items: center;
    }
    .pill {
      background: var(--elev); color: var(--fg); border:1px solid var(--line);
      border-radius: 999px; padding:.6rem .9rem; outline: none; display:flex; align-items:center; gap:.5rem;
    }
    .pill input { background: transparent; border:0; color: inherit; outline:none; min-width: 12ch; }
  .pill select { background: transparent; border:0; color: inherit; outline:none; min-width: 12ch; font: inherit; }
  .pill .lbl { font-size: .82rem; color: var(--muted); margin-right: .25rem; white-space: nowrap; }
    .pill input::placeholder { color: var(--muted); }
    .btn { border-radius: 999px; padding:.6rem 1rem; border:1px solid var(--line); background: var(--elev); color: var(--fg); cursor:pointer; }
    .btn.primary { background: var(--accent); color: var(--accent-fg); border-color: transparent; }
    .btn.ghost { background: transparent; }
    .btn:focus-visible, input:focus-visible, select:focus-visible {
      outline: 2px solid color-mix(in oklab, var(--accent) 60%, transparent); outline-offset: 2px;
    }

    /* Main layout */
    main { 
      padding: var(--space-3) 0 env(safe-area-inset-bottom); 
      flex: 1 1 auto; 
      overflow: hidden; 
      min-height: 0; /* Importante para flexbox */
    }
    .grid { 
      display: grid; 
      grid-template-columns: 1.15fr 1fr; 
      gap: var(--space-5); 
      align-items: stretch; 
      height: 100%; 
      min-height: 0; 
    }
    .wrap.grid { 
      height: 100%; 
      min-height: 0; 
      max-height: 100%; /* Prevenir overflow */
    }
    @media (max-width: 1100px) { 
      .grid { 
        grid-template-columns: 1fr; 
        grid-template-rows: 1fr auto; /* En m√≥vil, hacer el viewer m√°s peque√±o */
      } 
    }

    /* Panels */
    .panel {
      background: var(--panel-solid); 
      border: 1px solid var(--line); 
      border-radius: var(--radius); 
      box-shadow: var(--shadow-1);
      overflow: hidden; 
      display: flex; 
      flex-direction: column; 
      min-height: 0; 
      height: 100%;
      max-height: 100vh; /* Prevenir que crezca m√°s que la ventana */
    }
    .results { 
      flex: 1 1 auto; 
      overflow-y: auto; 
      overflow-x: hidden;
      padding: .5rem; 
      -webkit-overflow-scrolling: touch;
      /* Scroll suave en WebKit */
      scrollbar-width: thin;
      scrollbar-color: var(--line) transparent;
    }
    /* Mejorar scrollbars en WebKit */
    .results::-webkit-scrollbar {
      width: 8px;
    }
    .results::-webkit-scrollbar-track {
      background: transparent;
    }
    .results::-webkit-scrollbar-thumb {
      background-color: var(--line);
      border-radius: 4px;
    }
    .results::-webkit-scrollbar-thumb:hover {
      background-color: var(--muted);
    }
    .viewer { min-height: 0; height: 100%; display:flex; flex-direction: column; }
  .viewer-head { padding: .6rem .8rem; border-bottom:1px solid var(--line); display:flex; flex-direction: column; gap:.5rem; }
  .viewer-head .spacer { flex:1 1 auto; }
  .controls-row { display:flex; align-items:center; gap:.6rem; flex-wrap: wrap; }
    .viewer-body { flex: 1 1 auto; min-height: 0; overflow:hidden; padding: .6rem; display:flex; }
    .reader {
      width:100%; height: 100%; min-height: 0; border:1px solid var(--line); background: var(--panel-solid);
      border-radius: 10px; flex: 1 1 auto; color: var(--fg);
      font-size: var(--reader-font-size, 1rem);
      line-height: var(--reader-line-height, 1.6);
      font-family: var(--reader-family, serif);
      padding: var(--reader-padding, 1.25rem);
      overflow: auto; -webkit-overflow-scrolling: touch;
    }
  .reader.page-mode { scroll-behavior: smooth; scroll-snap-type: y mandatory; }
  .reader.page-mode * { scroll-snap-align: start; }
    /* Optional margins for readability */
    .reader p { margin: 0 0 0.75em; }

    /* Book list - Dise√±o mejorado */
    .book {
      background: var(--panel-solid);
      border: 1px solid var(--line);
      border-radius: 12px;
      padding: 1.25rem;
      margin-bottom: 1rem;
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
      transition: all 0.2s ease;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      position: relative;
      /* Prevenir problemas de layout */
      box-sizing: border-box;
      width: 100%;
      max-width: 100%;
    }

    /* Contenedor del listado */
    #list {
      width: 100%;
      box-sizing: border-box;
    }

    .book:hover { 
      background: color-mix(in oklab, var(--panel-solid) 95%, var(--accent) 5%); 
      transform: translateY(-2px); 
      box-shadow: 0 4px 16px rgba(0,0,0,0.1);
      border-color: var(--accent);
    }
    
    .book-header {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 1rem;
    }
    
    .book-info {
      flex: 1;
      min-width: 0;
    }
    
    .book h4 { 
      margin: 0 0 0.25rem 0; 
      font-size: 1.1rem; 
      line-height: 1.4; 
      font-weight: 600;
      color: var(--fg);
    }
    
    .book-author {
      font-size: 0.95rem;
      color: var(--muted);
      font-weight: 500;
      margin-bottom: 0.5rem;
    }
    
    .book-meta {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      align-items: center;
      font-size: 0.85rem;
      color: var(--muted);
      margin-bottom: 0.75rem;
    }
    
    .book-meta .meta-item {
      display: flex;
      align-items: center;
      gap: 0.25rem;
    }
    
    .book-meta .meta-separator {
      color: var(--line);
    }
    
    .book-state-icons {
      display: flex;
      gap: 0.4rem;
      align-items: center;
    }
    
    .state-icon { 
      font-size: 1rem;
      padding: 0.2rem;
      border-radius: 4px;
      background: rgba(0,0,0,0.05);
    }
    .state-icon[title="Favorito"] { color: #ff9500; background: rgba(255,149,0,0.15); }
    .state-icon[title="Le√≠do"] { color: #34c759; background: rgba(52,199,89,0.15); }
    .state-icon[title="Pendiente"] { color: #007aff; background: rgba(0,122,255,0.15); }
    .state-icon[title="Con marcadores"] { color: #8e44ad; background: rgba(142,68,173,0.15); }
    .state-icon[title="Con notas"] { color: #e67e22; background: rgba(230,126,34,0.15); }
    
    .chips { 
      display: flex; 
      gap: 0.4rem; 
      flex-wrap: wrap; 
      margin-bottom: 0.75rem;
    }
    .chip { 
      background: var(--chip); 
      color: var(--chip-fg); 
      border: 1px solid var(--line); 
      padding: 0.25rem 0.6rem; 
      border-radius: 6px; 
      font-size: 0.75rem;
      font-weight: 500;
      transition: all 0.15s ease;
    }
    .chip:hover {
      background: var(--accent);
      color: var(--accent-fg);
      border-color: var(--accent);
    }

    /* Progress bar mejorada */
    .progress-bar { 
      width: 100%; 
      height: 6px; 
      background: var(--line); 
      border-radius: 3px; 
      margin: 0.5rem 0;
      overflow: hidden;
    }
    .progress-fill { 
      height: 100%; 
      background: linear-gradient(90deg, var(--accent), color-mix(in oklab, var(--accent) 80%, #fff 20%)); 
      border-radius: 3px; 
      transition: width 0.3s ease;
      position: relative;
    }
    .progress-fill::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
      animation: shimmer 2s infinite;
    }
    
    @keyframes shimmer {
      0% { transform: translateX(-100%); }
      100% { transform: translateX(100%); }
    }
    
    /* History breadcrumbs */
    .history { display: flex; gap: .5rem; align-items: center; padding: .5rem 0; border-bottom: 1px solid var(--line); }
    .history-item { background: var(--chip); color: var(--chip-fg); padding: .2rem .5rem; border-radius: 999px; font-size: .75rem; cursor: pointer; }
    .history-item:hover { background: var(--accent); color: var(--accent-fg); }
    
    /* Grid view */
    /* Grid view mejorada */
    .grid-view #list { 
      display: grid; 
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); 
      gap: 1.5rem; 
      padding: 1rem;
      width: 100%;
      box-sizing: border-box;
    }
    .grid-view .book { 
      display: flex; 
      flex-direction: column; 
      width: 100%;
      margin: 0;
      text-align: left;
      min-height: 200px;
      max-width: 100%;
      box-sizing: border-box;
    }
    /* Cover image styles (shared for list and grid) */
    .book-cover { position: relative; }
    .book-cover .cover-img { 
      width: 100%; 
      aspect-ratio: 2 / 3; 
      object-fit: cover; 
      border-radius: 10px; 
      box-shadow: 0 2px 10px rgba(0,0,0,0.2); 
      background: #222; 
    }
    /* In list mode, shrink the cover on the right */
    .book-header .book-cover { flex: 0 0 120px; }
    .book-header .book-cover .cover-img { width: 120px; }
    
    /* Efectos adicionales para las fichas */
    .book-checkbox {
      position: absolute;
      top: 1rem;
      right: 1rem;
      width: 20px;
      height: 20px;
      accent-color: var(--accent);
      z-index: 2;
    }
    
    /* Estados de enriquecimiento */
    .book[data-enrichment-status="ok"] {
      border-left: 4px solid #34c759;
    }
    .book[data-enrichment-status="failed"] {
      border-left: 4px solid #ff3b30;
    }
    .book[data-enrichment-status="none"] {
      border-left: 4px solid var(--muted);
    }
    
    /* Indicador de clic */
    .book:active {
      transform: translateY(0px) scale(0.98);
    }
    
    /* Mejoras para dispositivos m√≥viles */
    @media (max-width: 768px) {
      .book {
        margin-bottom: 0.75rem;
        padding: 1rem;
      }
      .actions {
        flex-direction: column;
        gap: 0.5rem;
      }
      .action {
        justify-content: center;
        min-width: 100%;
      }
      .grid-view #list {
        grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
        gap: 1rem;
        padding: 0.5rem;
      }
    }
    
    /* Animaci√≥n de carga para enriquecimiento */
    .book.enriching {
      position: relative;
      opacity: 0.7;
    }
    .book.enriching::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
      animation: loading 1.5s infinite;
    }
    
    @keyframes loading {
      0% { transform: translateX(-100%); }
      100% { transform: translateX(100%); }
    }
    .batch-mode .book-checkbox { position: absolute; top: .5rem; left: .5rem; z-index: 2; }
    .batch-toolbar { 
      display: none; 
      padding: .5rem; 
      background: var(--elev); 
      border-bottom: 1px solid var(--line); 
      gap: .5rem; 
      align-items: center;
      flex-shrink: 0; /* No reducir la toolbar */
      min-height: 48px; /* Altura consistente */
      flex-wrap: wrap; /* Permitir wrap en pantallas peque√±as */
    }
    .batch-mode .batch-toolbar { display: flex; }
    
    /* Group headers */
    .group-header { background: var(--chip); color: var(--chip-fg); padding: .5rem 1rem; margin: .5rem 0; border-radius: 8px; font-weight: bold; }
    
    /* Night mode auto detection */
    @media (prefers-color-scheme: dark) {
      :root:not([data-theme]) { --bg: #0d0f14; --panel: #0f172acc; --panel-solid: #0f172a; --elev: #121826; --fg: #e6edf5; --muted: #9aa8bb; --line: #1f2a40; --accent: #0a84ff; --accent-fg: #08111f; --chip: #111a2f; --chip-fg: #b8c6d9; --kbd-bg:#0b1220; --kbd-fg:#cbd5e1; --kbd-br:#1f2a40; }
    }

    .actions { display:flex; gap:.4rem; margin-top:.35rem; flex-wrap: wrap; }
    /* Actions mejoradas */
    .actions { 
      display: flex; 
      gap: 0.5rem; 
      flex-wrap: wrap;
      align-items: center;
      padding-top: 0.5rem;
      border-top: 1px solid var(--line);
      z-index: 10; /* Asegurar que est√© encima */
      position: relative; /* Para que z-index funcione */
    }
    .action { 
      padding: 0.5rem 1rem; 
      border-radius: 8px; 
      border: 1px solid var(--line); 
      background: var(--bg); 
      color: var(--fg); 
      cursor: pointer; 
      font-size: 0.85rem;
      font-weight: 500;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 0.4rem;
      transition: all 0.15s ease;
      min-height: 36px;
      box-sizing: border-box;
      z-index: 10; /* Asegurar que est√© encima */
      position: relative; /* Para que z-index funcione */
    }
    .action:hover { 
      background: var(--accent); 
      color: var(--accent-fg); 
      border-color: var(--accent);
      transform: translateY(-1px);
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    }
    .action.ghost { 
      background: transparent; 
      border-color: transparent;
      color: var(--muted);
    }
    .action.ghost:hover { 
      background: var(--elev); 
      color: var(--fg);
      border-color: var(--line);
    }
    
    .action.primary {
      background: var(--accent);
      color: var(--accent-fg);
      border-color: var(--accent);
    }
    .action.primary:hover {
      background: color-mix(in oklab, var(--accent) 90%, #000 10%);
      transform: translateY(-1px);
      box-shadow: 0 3px 12px rgba(0,0,0,0.2);
    }
    
    .action-icon {
      font-size: 0.9rem;
    }
    .action.primary { background: var(--accent); color: var(--accent-fg); border-color: transparent; }
    .footerbar { 
      padding: .6rem .8rem; 
      border-top: 1px solid var(--line); 
      display: flex; 
      align-items: center; 
      gap: .6rem; 
      background: color-mix(in oklab, var(--panel-solid) 92%, transparent);
      flex-shrink: 0; /* No reducir el footer */
      min-height: 48px; /* Altura m√≠nima consistente */
    }
    .spacer { flex: 1 1 auto; }
    .status { padding:.35rem .6rem; background: var(--chip); color: var(--chip-fg); border:1px solid var(--line); border-radius: 999px; }
    .kbd{font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; padding:.05rem .35rem; border-radius:6px; border:1px solid var(--kbd-br); background:var(--kbd-bg); color:var(--kbd-fg); font-size:.82em;}
    .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;clip:rect(0,0,0,0);white-space:nowrap;border:0;overflow:hidden}

  @media (prefers-reduced-motion: reduce) {
      * { transition: none !important; }
    }

    /* E-reader and high-contrast friendly fallbacks */
    @media (prefers-contrast: more) {
      .logo { box-shadow: none; }
    }
    @media (forced-colors: active) {
      header, .panel, .pill, .btn, .action, .chip, .footerbar { border: 1px solid CanvasText; }
      .btn.primary, .action.primary { background: Highlight; color: HighlightText; }
    }
    @media (prefers-reduced-transparency: reduce) {
      header { background: var(--panel-solid); backdrop-filter: none; -webkit-backdrop-filter: none; }
    }
    /* Small screens adjustments */
    @media (max-width: 600px) {
      .nav { padding: .6rem 0; }
      .filters { padding: .6rem 0 .8rem; gap: .4rem; }
      .pill input { min-width: 10ch; }
      .grid { gap: var(--space-4); }
      .btn, .action { padding:.55rem .9rem; }
      .viewer-body { padding: .75rem; }
    }
  </style>
</head>
<body>
  <header>
    <div class="wrap nav">
      <div class="brand" aria-label="The Archive">
        <!-- Inlined SVG logo (from biblioteca.svg) -->
        <svg class="logo" aria-hidden="true" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" preserveAspectRatio="xMidYMid meet">
        	<path d="M 759.500 262.130 C 690.003 283.170, 598.177 301.233, 525.500 308.160 C 498.747 310.710, 443.463 311.259, 422.500 309.183 C 367.741 303.759, 317.231 293.034, 258.768 274.417 C 252.866 272.538, 247.506 271, 246.856 271 C 245.954 271, 245.830 286.500, 246.330 336.750 C 246.690 372.913, 247.442 453.350, 248 515.500 C 248.559 577.650, 249.128 631.987, 249.265 636.250 C 249.403 640.513, 249.470 644, 249.415 644 C 248.157 644, 196.518 650.195, 194.239 650.620 C 188.966 651.601, 189.558 652.796, 195.736 653.643 C 198.906 654.077, 243.350 654.271, 294.500 654.074 C 403.113 653.654, 475.587 653.669, 672.500 654.149 C 751.700 654.342, 818.188 654.142, 820.250 653.705 C 822.313 653.267, 824 652.539, 824 652.086 C 824 651.634, 822.313 651.021, 820.250 650.725 C 818.188 650.429, 806.163 648.771, 793.529 647.039 C 780.894 645.307, 770.488 643.803, 770.403 643.695 C 770.319 643.588, 770.831 594.225, 771.542 534 C 773.749 346.929, 774.347 257.994, 773.397 258.097 C 772.904 258.151, 766.650 259.966, 759.500 262.130 M 758 267.973 C 744.921 272.236, 707.309 282.080, 682 287.866 C 624.578 300.991, 573.882 309.029, 516 314.185 C 496.604 315.912, 430.976 315.910, 412.500 314.180 C 381.211 311.252, 342.009 304.758, 311 297.368 C 298.842 294.470, 269.073 285.884, 262.682 283.431 C 261.091 282.821, 260.903 283.211, 261.182 286.551 C 261.455 289.827, 261.925 290.486, 264.500 291.203 C 315.931 305.518, 361.004 313.632, 414.500 318.203 C 437.328 320.154, 494.326 319.843, 516.500 317.646 C 589.985 310.367, 664.197 296.718, 736 277.276 C 747.275 274.224, 757.531 271.506, 758.792 271.238 L 761.083 270.751 760.429 362.625 C 759.529 489.047, 760.744 647, 762.617 647 C 763.775 647, 764.030 617.294, 764.245 457 C 764.499 267.559, 764.494 267, 762.500 267.079 C 761.400 267.122, 759.375 267.525, 758 267.973 M 255.734 281.734 C 255.512 282.155, 255.738 323, 256.236 372.500 C 256.734 422, 256.951 504.478, 256.718 555.784 C 256.410 623.500, 256.597 648.968, 257.397 648.703 C 258.939 648.192, 259.728 611.872, 260.150 522 C 260.471 453.760, 260.175 420.040, 258.358 317.723 C 257.798 286.169, 257.263 278.833, 255.734 281.734 M 742 307.110 C 704.738 314.727, 651.784 323.512, 622 327.019 C 617.875 327.505, 602.125 329.479, 587 331.405 C 547.520 336.434, 529.111 338.013, 477.500 340.798 L 464.500 341.500 464.701 382 L 464.902 422.500 469.201 422.500 L 473.500 422.500 474.651 393 C 475.284 376.775, 475.847 361.773, 475.901 359.662 L 476 355.824 479.750 356.385 C 492.707 358.324, 492.763 358.323, 493.477 356.072 C 494.129 354.018, 494.632 353.955, 508.326 354.223 L 522.500 354.500 522.500 364.500 C 522.500 370, 522.135 384.512, 521.690 396.750 C 520.887 418.812, 520.897 419, 522.940 419 C 524.980 419, 525 418.665, 525 384.884 L 525 350.767 531.500 351.181 C 537.808 351.583, 538 351.524, 538 349.196 C 538 346.884, 538.223 346.811, 544.250 347.149 L 550.500 347.500 550.813 344.250 L 551.127 341 559.563 341 L 568 341 568 376.441 C 568 409.950, 568.378 414.955, 570.734 412.600 C 571.064 412.269, 571.726 396.587, 572.204 377.750 C 572.683 358.912, 573.294 342.476, 573.562 341.225 C 574.028 339.055, 574.351 338.980, 580.525 339.613 L 587 340.276 587 336.529 L 587 332.781 594.750 333.233 C 600.900 333.591, 603.945 333.225, 609.500 331.459 C 620.263 328.036, 621.687 327.830, 623.317 329.460 C 624.599 330.742, 626.043 330.560, 635.074 327.979 C 640.737 326.360, 645.517 325.184, 645.698 325.365 C 645.879 325.546, 646.434 342.225, 646.931 362.431 C 647.428 382.636, 648.097 399.430, 648.417 399.751 C 648.738 400.071, 649 383.383, 649 362.667 C 649 341.950, 649.112 324.970, 649.250 324.934 C 651.805 324.261, 667.709 322.384, 668.250 322.692 C 668.663 322.926, 669 339.567, 669 359.670 L 669 396.223 672.750 395.522 C 674.813 395.137, 676.643 394.682, 676.817 394.511 C 676.991 394.340, 677.843 378.742, 678.710 359.850 C 679.577 340.957, 680.428 325.331, 680.601 325.125 C 680.775 324.919, 687.011 324.517, 694.458 324.233 L 708 323.716 707.999 326.608 C 707.996 332.092, 705.018 382.506, 704.534 385.250 C 704.116 387.625, 704.380 388, 706.466 388 C 707.795 388, 709.099 387.648, 709.365 387.218 C 709.631 386.788, 710.808 372.275, 711.981 354.968 C 713.154 337.661, 714.321 322.102, 714.575 320.394 C 715.020 317.400, 715.289 317.245, 721.961 316.144 C 725.769 315.515, 729.546 315, 730.353 315 C 731.309 315, 732.852 318.072, 734.775 323.808 C 737.678 332.464, 737.715 332.837, 736.912 345.558 C 736.462 352.676, 736.073 363.563, 736.047 369.750 C 735.993 382.749, 735.257 382.103, 747.053 379.420 L 754 377.840 754 341.420 C 754 312.906, 753.729 305.018, 752.750 305.084 C 752.063 305.131, 747.225 306.042, 742 307.110 M 721.500 319.877 L 718.500 320.518 716.880 342.509 C 715.989 354.604, 714.930 369.385, 714.527 375.355 L 713.793 386.211 718.147 385.502 C 720.541 385.113, 722.906 384.412, 723.403 383.944 C 724.202 383.192, 726.430 359.104, 728.463 329.250 L 729.160 319 726.830 319.118 C 725.549 319.183, 723.150 319.525, 721.500 319.877 M 268.663 351.596 C 268.298 369.047, 268 390.850, 268 400.045 L 268 416.763 276.571 417.477 C 281.285 417.870, 285.448 417.886, 285.821 417.513 C 286.194 417.139, 286.659 397.071, 286.853 372.917 C 287.199 329.924, 287.248 329, 289.187 329 C 290.277 329, 297.691 331.025, 305.662 333.500 C 313.634 335.975, 320.346 338, 320.578 338 C 320.810 338, 321 356.675, 321 379.500 L 321 421 324.654 421 L 328.308 421 327.664 406.250 C 327.311 398.137, 326.767 382.275, 326.455 371 L 325.890 350.500 329.195 344.500 C 332.487 338.523, 332.519 338.499, 337.500 338.176 C 346.119 337.616, 353.159 338.892, 353.741 341.119 C 354.203 342.886, 355.043 343.039, 362.875 342.782 L 371.500 342.500 371.761 382.250 C 371.981 415.562, 372.250 422, 373.425 422 C 374.607 422, 374.802 415.978, 374.664 383.750 L 374.500 345.500 386.125 345.219 C 396.762 344.963, 397.792 345.097, 398.239 346.805 C 398.697 348.559, 399.168 348.595, 406.094 347.419 C 410.147 346.731, 413.808 346.381, 414.231 346.643 C 414.654 346.904, 415 348.441, 415 350.059 C 415 352.488, 415.413 353, 417.375 353 C 418.681 353, 421.156 353.281, 422.875 353.625 C 425.740 354.198, 426 354.032, 426 351.625 L 426 349 434.750 349.015 C 439.563 349.024, 444.134 349.432, 444.909 349.923 C 446.097 350.675, 446.226 356.519, 445.729 387.157 L 445.139 423.500 450.567 423.500 L 455.994 423.500 455.997 382.444 L 456 341.388 427.250 340.177 C 380.351 338.201, 344.198 333.967, 292.500 324.393 C 282.050 322.458, 272.561 320.647, 271.413 320.370 C 269.340 319.868, 269.321 320.086, 268.663 351.596 M 656.750 327.728 L 653 328.121 653 363.560 C 653 383.052, 653.337 398.991, 653.750 398.981 C 654.163 398.970, 656.750 398.378, 659.500 397.666 L 664.500 396.370 664.763 361.685 L 665.026 327 662.763 327.168 C 661.518 327.261, 658.813 327.513, 656.750 327.728 M 683.996 329.750 C 683.993 330.712, 683.320 345.415, 682.500 362.421 C 681.680 379.428, 681.120 393.420, 681.255 393.514 C 681.390 393.608, 685.650 392.757, 690.722 391.623 L 699.943 389.560 700.479 385.530 C 701.213 380.009, 704 338.009, 704 332.476 L 704 328 694 328 C 685.145 328, 683.999 328.200, 683.996 329.750 M 634.750 331.771 L 630 333.351 630 351.516 C 630 361.506, 630.294 377.125, 630.652 386.225 L 631.305 402.769 635.402 402.241 C 643.640 401.179, 643.752 401.046, 643.362 392.830 C 643.171 388.798, 642.735 373.012, 642.393 357.750 C 641.951 337.974, 641.446 330.027, 640.636 330.096 C 640.011 330.148, 637.362 330.902, 634.750 331.771 M 614 333.709 C 611.525 334.510, 609.011 335.312, 608.412 335.489 C 607.673 335.709, 607.104 346.944, 606.636 370.546 C 606.257 389.650, 606.110 405.443, 606.310 405.643 C 607.023 406.356, 616.013 404.709, 617.382 403.615 C 618.504 402.718, 618.910 395.593, 619.455 367.250 C 619.828 347.863, 619.766 332.057, 619.317 332.126 C 618.867 332.195, 616.475 332.908, 614 333.709 M 290.994 367.750 C 290.991 386.313, 290.702 405.180, 290.351 409.678 L 289.715 417.856 293.107 418.385 C 294.973 418.676, 301.072 419.192, 306.660 419.531 L 316.819 420.147 317.183 380.824 C 317.383 359.196, 317.499 341.388, 317.442 341.252 C 317.259 340.819, 293.590 334, 292.267 334 C 291.269 334, 290.999 341.174, 290.994 367.750 M 590.660 352.750 C 590.301 361.413, 590.005 377.601, 590.003 388.725 L 590 408.950 593.250 408.334 C 600.317 406.995, 600 408.059, 600.004 385.715 C 600.006 374.597, 600.301 359.087, 600.659 351.250 L 601.311 337 596.312 337 L 591.313 337 590.660 352.750 M 335.341 358.613 C 335.703 367.801, 336 385.373, 336 397.660 L 336 420 343.617 420 L 351.233 420 350.495 383.750 C 350.089 363.813, 349.699 346.375, 349.629 345 C 349.505 342.599, 349.208 342.488, 342.091 342.203 L 334.682 341.906 335.341 358.613 M 576.599 366.648 C 575.365 413.213, 575.350 411.516, 577 411.336 C 577.825 411.247, 580.188 410.889, 582.250 410.541 L 586 409.909 586 376.955 C 586 349.660, 585.764 344, 584.625 344 C 583.869 344, 581.896 343.729, 580.240 343.398 L 577.230 342.796 576.599 366.648 M 366.500 345.588 C 365.950 345.728, 363.475 346.113, 361 346.444 L 356.500 347.046 356.760 381.273 C 356.903 400.098, 357.241 416.484, 357.513 417.686 C 357.952 419.634, 358.514 419.824, 362.671 419.435 C 365.237 419.194, 367.491 418.842, 367.680 418.653 C 368.587 417.747, 367.417 345.354, 366.500 345.588 M 554.833 379.249 C 555.016 398.086, 555.250 413.583, 555.352 413.685 C 555.454 413.788, 557.442 413.616, 559.769 413.304 L 564 412.737 564 378.868 L 564 345 559.250 344.999 L 554.500 344.999 554.833 379.249 M 386 349 L 378.500 349.500 378.525 358.250 C 378.539 363.063, 378.651 379.375, 378.775 394.500 L 379 422 387.335 422 L 395.670 422 395.225 385.750 C 394.981 365.813, 394.492 349.275, 394.140 349 C 393.788 348.725, 390.125 348.725, 386 349 M 403.500 351.878 C 400.729 352.471, 400.503 352.844, 400.545 356.760 C 400.570 359.092, 400.683 374.725, 400.795 391.500 L 401 422 405.371 422 L 409.742 422 410.312 417.250 C 410.625 414.637, 410.931 398.663, 410.991 381.750 L 411.101 351 408.801 351.118 C 407.535 351.183, 405.150 351.525, 403.500 351.878 M 542 383.569 L 542 416 546.514 416 L 551.028 416 550.764 383.835 L 550.500 351.670 546.250 351.404 L 542 351.138 542 383.569 M 429.660 377.162 C 429.297 390.451, 429 406.201, 429 412.162 L 429 423 434.861 423 L 440.721 423 441.352 417.750 C 441.699 414.863, 441.987 399.113, 441.991 382.750 L 442 353 436.160 353 L 430.320 353 429.660 377.162 M 528.700 354.926 C 528.590 355.242, 528.625 369.588, 528.778 386.806 L 529.056 418.112 533.278 417.806 L 537.500 417.500 537.500 386.500 L 537.500 355.500 533.200 354.926 C 530.835 354.611, 528.810 354.611, 528.700 354.926 M 415 389.916 L 415 423.110 419.750 422.805 L 424.500 422.500 425.159 390.500 C 425.522 372.900, 425.696 358.374, 425.545 358.219 C 425.394 358.064, 422.960 357.664, 420.136 357.330 L 415 356.721 415 389.916 M 498.604 368.500 C 498.296 374.550, 497.778 387.825, 497.453 398 C 497.128 408.175, 496.603 417.575, 496.287 418.889 L 495.713 421.278 506.107 420.546 C 511.823 420.143, 516.591 419.728, 516.701 419.622 C 517.061 419.280, 519.164 358.830, 518.827 358.508 C 518.647 358.336, 514.149 358.039, 508.832 357.848 L 499.164 357.500 498.604 368.500 M 479.661 365.202 C 479.341 367.566, 478.800 380.525, 478.459 394 C 478.118 407.475, 477.620 419.288, 477.352 420.250 C 476.927 421.776, 477.633 422, 482.874 422 C 486.178 422, 489.109 421.632, 489.387 421.183 C 489.665 420.733, 489.970 407.121, 490.065 390.933 L 490.238 361.500 485.240 361.202 L 480.242 360.904 479.661 365.202 M 688.623 382.519 C 686.422 384.721, 688.220 388.252, 691.318 387.811 C 693.004 387.571, 693.500 386.822, 693.500 384.514 C 693.500 381.021, 691.103 380.040, 688.623 382.519 M 740 385.533 C 706.374 393.184, 661.475 402.478, 636.500 406.957 C 630.450 408.042, 621.675 409.633, 617 410.493 C 597.507 414.079, 532.684 422.960, 508 425.427 C 458.642 430.358, 390.082 429.880, 300.458 423.978 C 263.985 421.577, 264 421.577, 264 423.500 C 264 424.325, 264.563 425.004, 265.250 425.009 C 265.938 425.014, 272.575 425.451, 280 425.981 C 346.701 430.743, 379.987 432.084, 430.828 432.060 C 492.032 432.030, 535.307 428.211, 601.500 417 C 638.818 410.680, 720.854 394.241, 753.750 386.492 C 754.987 386.200, 756 385.295, 756 384.481 C 756 382.444, 752.590 382.668, 740 385.533 M 657.229 390.171 C 655.494 391.906, 655.703 394.672, 657.627 395.410 C 659.840 396.259, 662.163 394.136, 661.798 391.598 C 661.450 389.172, 658.995 388.405, 657.229 390.171 M 634.667 393.667 C 634.300 394.033, 634 395.413, 634 396.733 C 634 398.761, 634.426 399.084, 636.750 398.816 C 638.910 398.568, 639.568 397.910, 639.816 395.750 C 640.084 393.426, 639.761 393, 637.733 393 C 636.413 393, 635.033 393.300, 634.667 393.667 M 608.667 396.667 C 608.300 397.033, 608 398.392, 608 399.686 C 608 401.731, 608.359 401.960, 610.750 401.436 C 615.575 400.378, 616 400.103, 616 398.031 C 616 396.396, 615.350 396, 612.667 396 C 610.833 396, 609.033 396.300, 608.667 396.667 M 592.667 399.667 C 591.428 400.906, 591.989 403.782, 593.590 404.396 C 595.848 405.263, 597 404.265, 597 401.441 C 597 399.741, 596.444 399, 595.167 399 C 594.158 399, 593.033 399.300, 592.667 399.667 M 579.152 400.885 C 577.295 402.062, 578.116 405.399, 580.368 405.832 C 582.898 406.320, 584.334 404.626, 583.532 402.101 C 582.827 399.879, 581.375 399.476, 579.152 400.885 M 301.050 406.907 C 300.278 408.349, 300.455 409.340, 301.773 410.968 C 304.746 414.640, 309.223 411.153, 306.961 406.928 C 305.638 404.456, 302.368 404.445, 301.050 406.907 M 557.667 407.667 C 556.669 408.664, 556.863 412, 557.918 412 C 560.197 412, 562 410.628, 562 408.893 C 562 407.042, 559.110 406.224, 557.667 407.667 M 544.659 409.484 C 542.600 411.543, 543.654 414.191, 546.377 413.803 C 547.872 413.590, 548.500 412.785, 548.500 411.083 C 548.500 408.109, 546.759 407.384, 544.659 409.484 M 340.184 411.750 C 340.450 414.069, 340.971 414.500, 343.500 414.500 C 346.029 414.500, 346.550 414.069, 346.816 411.750 C 347.110 409.197, 346.873 409, 343.500 409 C 340.127 409, 339.890 409.197, 340.184 411.750 M 361.250 410.662 C 360.563 410.940, 360 412.254, 360 413.583 C 360 415.479, 360.526 416, 362.441 416 C 365.380 416, 366.090 415.061, 365.335 412.174 C 364.777 410.041, 363.741 409.657, 361.250 410.662 M 503.750 410.668 C 502.695 410.957, 502 412.111, 502 413.573 C 502 415.788, 502.399 416, 506.566 416 C 510.958 416, 511.121 415.895, 510.816 413.250 C 510.492 410.432, 507.978 409.513, 503.750 410.668 M 747.500 411.058 C 743.706 411.843, 693.880 419.920, 667 424.107 C 637.805 428.655, 592.823 434.563, 571.722 436.621 C 567.994 436.985, 564.787 437.556, 564.595 437.891 C 563.987 438.954, 566.661 527.994, 567.321 528.655 C 567.669 529.002, 568.158 528.659, 568.409 527.893 C 568.854 526.537, 571.012 463.488, 571.024 451.500 C 571.028 448.200, 571.383 444.945, 571.814 444.266 C 572.245 443.587, 578.537 441.810, 585.796 440.316 L 598.995 437.599 608.460 442.300 C 613.666 444.885, 618.849 447, 619.977 447 C 621.104 447, 622.877 447.531, 623.916 448.180 C 625.396 449.104, 627.894 448.987, 635.434 447.640 C 640.729 446.694, 645.555 446.225, 646.158 446.597 C 646.941 447.082, 647.045 457.319, 646.521 482.519 L 645.788 517.763 648.303 517.282 C 649.687 517.018, 651.032 515.985, 651.293 514.988 C 651.554 513.991, 651.821 504.023, 651.886 492.837 C 651.952 481.652, 652.296 464.962, 652.650 455.750 L 653.294 439 661.081 439 C 668.832 439, 668.869 438.987, 669.184 436.250 L 669.500 433.500 679.250 433.214 L 689 432.928 688.884 455.714 C 688.820 468.246, 688.482 485.181, 688.134 493.348 C 687.785 501.514, 687.805 508.383, 688.178 508.612 C 689.526 509.441, 689.850 505.048, 690.438 478 C 690.767 462.875, 691.300 446.868, 691.622 442.428 L 692.207 434.356 702.195 432.103 C 707.689 430.864, 712.418 430.085, 712.705 430.372 C 713.202 430.869, 711.517 482.501, 710.506 497.750 C 710.030 504.925, 710.319 505.582, 713.418 504.393 C 714.815 503.857, 715 500.066, 715 472.044 C 715 454.586, 715.285 436.925, 715.634 432.797 L 716.269 425.292 728.884 422.642 C 735.823 421.184, 742.288 419.994, 743.250 419.996 C 744.886 420, 745 422.495, 745 458.366 L 745 496.731 749.250 495.909 C 751.587 495.457, 753.837 495.068, 754.250 495.044 C 754.663 495.020, 755 475.875, 755 452.500 C 755 404.857, 755.811 409.338, 747.500 411.058 M 382 413.433 C 382 416.072, 383.610 416.867, 388.500 416.640 C 390.987 416.524, 391.554 416.030, 391.816 413.750 C 392.125 411.070, 392.003 411, 387.066 411 C 382.366 411, 382 411.176, 382 413.433 M 434.350 411.766 C 432.450 412.978, 432.383 416.159, 434.231 417.350 C 436.679 418.928, 439.959 415.743, 438.412 413.291 C 437.131 411.261, 435.879 410.791, 434.350 411.766 M 481.667 412.667 C 481.300 413.033, 481 414.383, 481 415.667 C 481 417.472, 481.551 418, 483.433 418 C 485.913 418, 487.748 415.020, 486.506 413.009 C 485.803 411.872, 482.682 411.651, 481.667 412.667 M 418.593 414.550 C 416.464 416.679, 416.927 419.500, 419.405 419.500 C 422.309 419.500, 423.827 416.398, 421.876 414.447 C 420.422 412.994, 420.140 413.003, 418.593 414.550 M 404.250 414.718 C 403.563 414.965, 403 416.254, 403 417.583 C 403 419.466, 403.529 420, 405.393 420 C 407.357 420, 409 418.385, 409 416.453 C 409 415.607, 405.419 414.299, 404.250 414.718 M 737.851 424.482 C 737.563 424.770, 733.316 425.813, 728.414 426.799 L 719.500 428.591 719.238 465.699 L 718.976 502.807 727.738 500.919 C 732.557 499.881, 737.495 498.592, 738.711 498.055 L 740.923 497.078 740.711 460.873 C 740.513 426.855, 740.146 422.187, 737.851 424.482 M 701.329 436.182 L 696.159 437.127 695.609 444.314 C 695.307 448.266, 694.786 464.269, 694.451 479.875 L 693.842 508.251 698.549 507.545 C 701.138 507.157, 703.817 506.624, 704.503 506.360 C 705.919 505.817, 706.665 496.381, 707.499 468.500 C 707.795 458.600, 708.285 447.012, 708.587 442.750 C 709.017 436.690, 708.850 435.026, 707.819 435.119 C 707.093 435.184, 704.173 435.663, 701.329 436.182 M 673.543 437.250 C 673.326 437.938, 672.949 455.093, 672.705 475.374 L 672.261 512.248 677.266 511.655 C 680.019 511.329, 682.466 510.867, 682.704 510.629 C 682.942 510.391, 683.402 493.502, 683.726 473.098 L 684.314 436 679.126 436 C 675.852 436, 673.792 436.461, 673.543 437.250 M 541 441.082 C 528.660 442.415, 484.820 445, 474.557 445 L 465 445 465 490 C 465 529.333, 465.189 535, 466.500 535 C 467.793 535, 468.030 531.097, 468.218 506.750 C 468.338 491.212, 468.530 476.475, 468.645 474 C 468.760 471.525, 468.887 468.680, 468.927 467.677 C 468.990 466.101, 469.778 465.891, 474.750 466.121 C 478.636 466.301, 480.541 466.001, 480.625 465.194 C 480.694 464.537, 480.806 461.525, 480.875 458.500 L 481 453 488.500 453 L 496 453 496 455.833 C 496 457.392, 496.202 458.869, 496.449 459.116 C 496.696 459.363, 499.284 459.325, 502.199 459.033 C 506.942 458.556, 507.468 458.270, 507.199 456.319 C 506.935 454.410, 507.496 454.058, 511.699 453.493 C 522.159 452.087, 521.463 451.716, 521.801 458.879 L 522.102 465.258 526.691 464.629 C 529.214 464.283, 532.116 464, 533.140 464 C 534.790 464, 535 463.144, 535 456.433 C 535 449.693, 535.192 448.922, 536.750 449.387 C 537.712 449.675, 540.750 450.439, 543.500 451.086 C 547.025 451.915, 549.754 453.465, 552.750 456.339 L 557 460.416 556.991 455.458 C 556.987 452.731, 556.699 448.137, 556.352 445.250 L 555.721 440 552.111 440.136 C 550.125 440.210, 545.125 440.636, 541 441.082 M 584.387 444.256 L 575.273 446.248 574.623 466.874 C 574.265 478.218, 573.687 496.439, 573.337 507.365 L 572.702 527.231 579.101 526.504 C 582.620 526.105, 587.300 525.479, 589.500 525.114 L 593.500 524.451 594.131 515.475 C 594.479 510.539, 595.100 491.988, 595.511 474.250 C 596.142 447.106, 596.042 442.021, 594.880 442.131 C 594.121 442.203, 589.399 443.159, 584.387 444.256 M 265 452.815 L 265 462.909 268.250 463.471 C 276.582 464.909, 276.196 465.125, 280.266 456.745 L 284.033 448.989 291.266 449.622 C 295.245 449.970, 298.786 450.535, 299.135 450.878 C 299.709 451.440, 296.831 513.044, 295.638 525.750 C 295.201 530.399, 295.360 531, 297.027 531 C 298.383 531, 299.047 530.091, 299.403 527.750 C 299.914 524.382, 300.017 523.010, 302.481 486.500 C 303.297 474.400, 304.221 462.619, 304.533 460.321 L 305.101 456.142 308.801 456.704 C 310.835 457.013, 316.775 458.003, 322 458.905 L 331.500 460.544 331.305 465.022 C 331.022 471.530, 327.089 521.572, 326.376 527.750 L 325.770 533 330.035 533 L 334.301 533 333.587 499.744 C 333.194 481.453, 333.189 462.989, 333.577 458.712 L 334.282 450.937 345.391 451.219 L 356.500 451.500 356.629* (truncated for patch context)" stroke="none" fill="black" fill-rule="evenodd"/>
	</svg>
        <span id="lbl-app">The Archive</span>
      </div>
      <div class="toolbar">
        <div class="seg" role="group" aria-label="Theme toggle">
          <button id="btn-theme-auto" aria-pressed="true" title="Auto" class="active">A</button>
          <button id="btn-theme-light" aria-pressed="false" title="Light">‚òÄÔ∏è</button>
          <button id="btn-theme-dark" aria-pressed="false" title="Dark">üåô</button>
        </div>
        <div class="seg" role="group" aria-label="Language">
          <select id="lang" aria-label="Language select">
            <option value="es">ES</option>
            <option value="en">EN</option>
            <option value="fr">FR</option>
            <option value="de">DE</option>
            <option value="pt">PT</option>
          </select>
          <span class="chev">‚ñæ</span>
        </div>
      </div>
    </div>

    <div class="wrap filters" role="search">
      <label class="pill" aria-label="Buscar">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" aria-hidden="true"><circle cx="11" cy="11" r="7" stroke="currentColor" stroke-width="2"/><path d="M20 20L17 17" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
        <input id="q" placeholder="Buscar..." aria-label="Buscar texto">
      </label>
      <label class="pill">
        <span class="lbl" id="lbl-author">Autor</span>
        <select id="autor" aria-label="Autor"><option value="">Autor</option></select>
      </label>
      <label class="pill"><span class="lbl" id="lbl-title">T√≠tulo</span><input id="titulo" placeholder="T√≠tulo" aria-label="T√≠tulo"></label>
      <label class="pill">
        <span class="lbl" id="lbl-genre">G√©nero</span>
        <select id="genre" aria-label="G√©nero"><option value="">G√©nero</option></select>
      </label>
      <label class="pill">
        <span class="lbl" id="lbl-year-from">Desde</span>
        <select id="year_from" aria-label="A√±o desde"></select>
      </label>
      <label class="pill">
        <span class="lbl" id="lbl-year-to">Hasta</span>
        <select id="year_to" aria-label="A√±o hasta"></select>
      </label>
      <label class="pill">
        <span class="lbl" id="lbl-state">Estado</span>
        <select id="state" aria-label="Estado">
          <option value="">‚Äî</option>
          <option value="favorite">Favoritos</option>
          <option value="read">Le√≠dos</option>
          <option value="pending">Pendientes</option>
        </select>
      </label>
      <label class="pill">
        <span class="lbl">Vista</span>
        <select id="viewMode" aria-label="Modo de vista">
          <option value="list">Lista</option>
          <option value="grid">Cuadr√≠cula</option>
        </select>
      </label>
      <label class="pill">
        <span class="lbl">Ordenar</span>
        <select id="sortBy" aria-label="Ordenar por">
          <option value="title">T√≠tulo</option>
          <option value="author">Autor</option>
          <option value="year">A√±o</option>
          <option value="added">Fecha a√±adido</option>
          <option value="progress">Progreso</option>
          <option value="genre">G√©nero</option>
        </select>
      </label>
      <label class="pill">
        <span class="lbl">Agrupar</span>
        <select id="groupBy" aria-label="Agrupar por">
          <option value="">Sin agrupar</option>
          <option value="author">Por autor</option>
          <option value="genre">Por g√©nero</option>
          <option value="year">Por a√±o</option>
        </select>
      </label>
      <button class="btn primary" id="btnSearch">Buscar</button>
      <button class="btn" id="btnReindex" title="Reindexar">Reindex</button>
      <button class="btn" id="btnEnrichAll" title="Enriquecer todos">Enriquecer todo</button>
      <button class="btn" id="btnEnrichNew" title="Enriquecer nuevos">Enriquecer nuevos</button>
      <button class="btn ghost" id="btnBatchMode" title="Selecci√≥n m√∫ltiple">‚òëÔ∏è Batch</button>
      <button class="btn ghost" id="btnExport" title="Exportar biblioteca">üì§ Export</button>
      <span class="status" id="status">Listo.</span>
    </div>
  </header>

  <main>
    <div class="wrap grid">
      <section class="panel">
        <div class="batch-toolbar">
          <span id="batchCount">0 seleccionados</span>
          <button class="btn" id="btnBatchRead">Marcar le√≠dos</button>
          <button class="btn" id="btnBatchFavorite">Marcar favoritos</button>
          <button class="btn" id="btnBatchDelete">Desmarcar</button>
          <button class="btn ghost" id="btnBatchCancel">Cancelar</button>
        </div>
        <div class="results" id="results">
          <div id="list"></div>
        </div>
        <div class="footerbar">
          <button class="btn" id="prev">‚óÄ</button>
          <span id="pageinfo" class="meta"></span>
          <button class="btn" id="next">‚ñ∂</button>
          <div class="spacer"></div>
          <span class="meta"><span id="lbl-tip">Tip:</span> <span class="kbd">Enter</span> <span id="lbl-tip2">to search</span></span>
        </div>
      </section>

      <section class="panel viewer" id="viewerPanel">
        <div class="viewer-head">
          <div class="meta" id="detail">‚Äî</div>
          <div class="controls-row">
            <div class="seg" role="group" aria-label="Reader mode">
              <button id="btnModeScroll" class="active" title="Scroll">Scroll</button>
              <button id="btnModePaged" title="P√°ginas">üìñ</button>
            </div>
            <div class="seg" role="group" aria-label="Font size">
              <button id="btnFontMinus" title="A-">A-</button>
              <button id="btnFontPlus" title="A+">A+</button>
            </div>
            <div class="seg" role="group" aria-label="Font family">
              <select id="fontFamily" aria-label="Font family">
                <option value="serif">Serif</option>
                <option value="Georgia, serif">Georgia</option>
                <option value="'Palatino Linotype', Palatino, serif">Palatino</option>
                <option value="'Times New Roman', Times, serif">Times</option>
                <option value="system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif">Sans</option>
                <option value="Helvetica, Arial, sans-serif">Helvetica</option>
                <option value="Verdana, Geneva, sans-serif">Verdana</option>
              </select>
              <span class="chev">‚ñæ</span>
            </div>
            <div class="seg" role="group" aria-label="Page nav" id="segPageNav">
              <button id="btnPagePrev" title="P√°gina anterior">‚óÄ</button>
              <button id="btnPageNext" title="P√°gina siguiente">‚ñ∂</button>
            </div>
            <button id="btnFullscreen" title="Pantalla completa">‚õ∂</button>
            <button id="btnBookmark" title="A√±adir marcador">üîñ</button>
            <button id="btnNotes" title="Notas">üìù</button>
          </div>
        </div>
        <div class="viewer-body">
          <div id="reader" class="reader scroll-mode" tabindex="0" role="document"></div>
        </div>
      </section>
    </div>
  </main>

  <script>
    // Base URL (file:// fallback)
    const base = (location.protocol === 'file:') ? 'http://localhost:8000' : '';
    const api = (p) => `${base}${p}`;

    // i18n
    const I18N = {
      es: { appName: "The Archive", searchPlaceholder: "Buscar... (t√≠tulo o autor)", authorPlaceholder: "Autor", titlePlaceholder: "T√≠tulo", genrePlaceholder: "G√©nero", yearFromPlaceholder: "A√±o desde", yearToPlaceholder: "A√±o hasta", search: "Buscar", reindex: "Reindex", ready: "Listo.", searching: "Buscando...", done: "Hecho.", error: "Error", open: "Abrir", download: "Descargar", enrich: "Enriquecer", enrichAll: "Enriquecer todo", enrichNew: "Enriquecer nuevos", enriching: "Enriqueciendo...", enrichingAll: "Enriquecer en lote...", enriched: "Enriquecido", started: "Iniciado", progress: "Progreso", pageInfo: "P√°gina {page} / {pages} ‚Ä¢ {total} resultados", tip: "Atajo:", tip2: "para buscar", reindexing: "Reindexando...", reindexed: "Reindex completo." },
      en: { appName: "The Archive", searchPlaceholder: "Search... (title or author)", authorPlaceholder: "Author", titlePlaceholder: "Title", genrePlaceholder: "Genre", yearFromPlaceholder: "Year from", yearToPlaceholder: "Year to", search: "Search", reindex: "Reindex", ready: "Ready.", searching: "Searching...", done: "Done.", error: "Error", open: "Open", download: "Download", enrich: "Enrich", enrichAll: "Enrich all", enrichNew: "Enrich new", enriching: "Enriching...", enrichingAll: "Batch enriching...", enriched: "Enriched", started: "Started", progress: "Progress", pageInfo: "Page {page} / {pages} ‚Ä¢ {total} results", tip: "Tip:", tip2: "to search", reindexing: "Reindexing...", reindexed: "Reindex complete." },
      fr: { appName: "The Archive", searchPlaceholder: "Rechercher... (titre ou auteur)", authorPlaceholder: "Auteur", titlePlaceholder: "Titre", genrePlaceholder: "Genre", yearFromPlaceholder: "Ann√©e min", yearToPlaceholder: "Ann√©e max", search: "Rechercher", reindex: "R√©indexer", ready: "Pr√™t.", searching: "Recherche...", done: "Termin√©.", error: "Erreur", open: "Ouvrir", download: "T√©l√©charger", enrich: "Enrichir", enrichAll: "Tout enrichir", enrichNew: "Nouveaux", enriching: "Enrichissement...", enrichingAll: "Enrichissement par lot...", enriched: "Enrichi", started: "D√©marr√©", progress: "Progression", pageInfo: "Page {page} / {pages} ‚Ä¢ {total} r√©sultats", tip: "Astuce:", tip2: "pour rechercher", reindexing: "R√©indexation...", reindexed: "Reindex complete." },
      de: { appName: "The Archive", searchPlaceholder: "Suchen... (Titel oder Autor)", authorPlaceholder: "Autor", titlePlaceholder: "Titel", genrePlaceholder: "Genre", yearFromPlaceholder: "Jahr von", yearToPlaceholder: "Jahr bis", search: "Suchen", reindex: "Reindizieren", ready: "Bereit.", searching: "Suche...", done: "Fertig.", error: "Fehler", open: "√ñffnen", download: "Herunterladen", enrich: "Anreichern", enrichAll: "Alle anreichern", enrichNew: "Neue anreichern", enriching: "Anreicherung...", enrichingAll: "Stapel-Anreicherung...", enriched: "Angereichert", started: "Gestartet", progress: "Fortschritt", pageInfo: "Seite {page} / {pages} ‚Ä¢ {total} Ergebnisse", tip: "Tipp:", tip2: "zum Suchen", reindexing: "Reindizierung...", reindexed: "Reindizierung abgeschlossen." },
      pt: { appName: "The Archive", searchPlaceholder: "Pesquisar... (t√≠tulo ou autor)", authorPlaceholder: "Autor", titlePlaceholder: "T√≠tulo", genrePlaceholder: "G√™nero", yearFromPlaceholder: "Ano de", yearToPlaceholder: "Ano at√©", search: "Buscar", reindex: "Reindexar", ready: "Pronto.", searching: "Buscando...", done: "Conclu√≠do.", error: "Erro", open: "Abrir", download: "Baixar", enrich: "Enriquecer", enrichAll: "Enriquecer tudo", enrichNew: "Enriquecer novos", enriching: "Enriquecendo...", enrichingAll: "Enriquecimento em lote...", enriched: "Enriquecido", started: "Iniciado", progress: "Progresso", pageInfo: "P√°gina {page} / {pages} ‚Ä¢ {total} resultados", tip: "Dica:", tip2: "para buscar", reindexing: "Reindexando...", reindexed: "Reindex conclu√≠do." }
    };
    let LANG = 'es'; const LANG_KEY = 'skald.lang';
    function t(key, params={}){ const d = I18N[LANG] || I18N.es; let s = (d[key] ?? I18N.es[key] ?? key); for (const [k,v] of Object.entries(params)) s = s.replaceAll(`{${k}}`, v); return s; }
    function applyI18n(){
      document.documentElement.lang = LANG;
      document.getElementById('lbl-app').textContent = t('appName');
      document.getElementById('q').placeholder = t('searchPlaceholder');
  // Visible labels
  document.getElementById('lbl-author').textContent = t('authorPlaceholder');
  document.getElementById('lbl-title').textContent = t('titlePlaceholder');
  document.getElementById('lbl-genre').textContent = t('genrePlaceholder');
  document.getElementById('lbl-year-from').textContent = t('yearFromPlaceholder');
  document.getElementById('lbl-year-to').textContent = t('yearToPlaceholder');
  // placeholders for selects are first options
      document.getElementById('titulo').placeholder = t('titlePlaceholder');
  document.querySelector('#autor option').textContent = t('authorPlaceholder');
  document.querySelector('#genre option').textContent = t('genrePlaceholder');
      document.getElementById('btnSearch').textContent = t('search');
      document.getElementById('btnReindex').textContent = t('reindex');
  document.getElementById('btnEnrichAll').textContent = t('enrichAll');
  document.getElementById('btnEnrichNew').textContent = t('enrichNew');
  document.getElementById('lbl-state').textContent = 'Estado';
      document.getElementById('status').textContent = t('ready');
      document.getElementById('lbl-tip').textContent = t('tip');
      document.getElementById('lbl-tip2').textContent = t('tip2');
      renderList({total: state.total, items: state.items, page: state.page, page_size: state.page_size});
    }
    function setLang(l){ if (!I18N[l]) return; LANG = l; localStorage.setItem(LANG_KEY, l); document.getElementById('lang').value = l; applyI18n(); }
    function initLang(){ const saved = localStorage.getItem(LANG_KEY); const nav = (navigator.language || 'es').slice(0,2).toLowerCase(); setLang(saved || (I18N[nav] ? nav : 'es')); }

    // Theme (dark/light/auto)
    const THEME_KEY = 'skald.theme';
    let mediaDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)');
    function setTheme(theme){
      localStorage.setItem(THEME_KEY, theme);
      const t = theme === 'auto' ? (mediaDark && mediaDark.matches ? 'dark' : 'light') : theme;
      document.documentElement.setAttribute('data-theme', t);
      // segmented state
      document.getElementById('btn-theme-auto').classList.toggle('active', theme==='auto');
      document.getElementById('btn-theme-light').classList.toggle('active', theme==='light');
      document.getElementById('btn-theme-dark').classList.toggle('active', theme==='dark');
      document.getElementById('btn-theme-auto').setAttribute('aria-pressed', theme==='auto');
      document.getElementById('btn-theme-light').setAttribute('aria-pressed', theme==='light');
      document.getElementById('btn-theme-dark').setAttribute('aria-pressed', theme==='dark');
    }
    function initTheme(){
      const saved = localStorage.getItem(THEME_KEY) || 'auto';
      setTheme(saved);
      if (mediaDark) {
        mediaDark.addEventListener ? mediaDark.addEventListener('change', () => {
          if ((localStorage.getItem(THEME_KEY) || 'auto') === 'auto') setTheme('auto');
        }) : mediaDark.addListener(() => { if ((localStorage.getItem(THEME_KEY) || 'auto') === 'auto') setTheme('auto'); });
      }
    }

    // State
    let state = { page: 1, page_size: 20, total: 0, items: [], lastQuery: {} };
    let recentBooks = []; // Reading history
    let recentSearches = []; // Search history
    let batchMode = false;
    let selectedBooks = new Set();
    let bookmarks = {}; // bookId -> [positions]
    let notes = {}; // bookId -> {position: note}
    let customLists = {}; // listName -> [bookIds]

    // Fetch helper
    async function fetchJSON(url, opts={}) {
      const res = await fetch(url, { ...opts });
      if (!res.ok) throw new Error(await res.text());
      const ct = res.headers.get('content-type') || '';
      return ct.includes('application/json') ? res.json() : res.text();
    }

    // History management
    function addToHistory(book) {
      recentBooks = recentBooks.filter(b => b.id !== book.id);
      recentBooks.unshift(book);
      if (recentBooks.length > 10) recentBooks.pop();
  localStorage.setItem('archive.history', JSON.stringify(recentBooks));
    }
    function loadHistory() {
  try { recentBooks = JSON.parse(localStorage.getItem('archive.history') || '[]'); } catch {}
    }
    function saveSearch(query) {
      if (!query.trim()) return;
      recentSearches = recentSearches.filter(q => q !== query);
      recentSearches.unshift(query);
      if (recentSearches.length > 5) recentSearches.pop();
  localStorage.setItem('archive.searches', JSON.stringify(recentSearches));
    }
    function loadSearchHistory() {
  try { recentSearches = JSON.parse(localStorage.getItem('archive.searches') || '[]'); } catch {}
    }
    
    // Bookmarks and notes
    function loadBookmarks() {
  try { bookmarks = JSON.parse(localStorage.getItem('archive.bookmarks') || '{}'); } catch {}
    }
    function saveBookmarks() {
  localStorage.setItem('archive.bookmarks', JSON.stringify(bookmarks));
    }
    function loadNotes() {
  try { notes = JSON.parse(localStorage.getItem('archive.notes') || '{}'); } catch {}
    }
    function saveNotes() {
  localStorage.setItem('archive.notes', JSON.stringify(notes));
    }
    function addBookmark() {
      if (!currentBookId) return;
      const r = document.getElementById('reader');
      const position = r ? r.scrollTop : 0;
      if (!bookmarks[currentBookId]) bookmarks[currentBookId] = [];
      bookmarks[currentBookId].push({ position, timestamp: Date.now(), page: readerPrefs.mode === 'paged' ? Math.floor(position / r.clientHeight) + 1 : null });
      saveBookmarks();
      alert('Marcador a√±adido');
    }
    function showNotes() {
      if (!currentBookId) return;
      const note = prompt('A√±adir nota:', notes[currentBookId]?.note || '');
      if (note !== null) {
        const r = document.getElementById('reader');
        const position = r ? r.scrollTop : 0;
        notes[currentBookId] = { note, position, timestamp: Date.now() };
        saveNotes();
      }
    }
    
    // Auto night mode
    function checkAutoNightMode() {
      const hour = new Date().getHours();
      const isNight = hour < 7 || hour > 20;
  const currentTheme = localStorage.getItem('archive.theme') || 'auto';
      if (currentTheme === 'auto') {
        document.documentElement.setAttribute('data-theme', isNight ? 'dark' : 'light');
      }
    }
    
    // Reading time estimation (words per minute)
    function estimateReadingTime(bookId) {
      // Simple estimation: average book ~70k words, average reading speed 200 WPM
      const book = state.items.find(b => b.id === bookId);
      if (!book) return null;
      const estimatedWords = (book.size_bytes || 100000) / 5; // rough chars to words
      const wordsPerMinute = 200;
      const totalMinutes = estimatedWords / wordsPerMinute;
      const progress = book.progress_percent || 0;
      const remainingMinutes = totalMinutes * (1 - progress / 100);
      const hours = Math.floor(remainingMinutes / 60);
      const minutes = Math.floor(remainingMinutes % 60);
      return hours > 0 ? `${hours}h ${minutes}m` : `${minutes}m`;
    }

    // Query builder
    function buildQuery() {
      const q = document.querySelector('#q').value.trim();
  const autor = document.querySelector('#autor').value.trim();
      const titulo = document.querySelector('#titulo').value.trim();
      const genre = document.querySelector('#genre').value.trim();
  const year_from = document.querySelector('#year_from').value;
  const year_to = document.querySelector('#year_to').value;
    const stateFilter = document.querySelector('#state').value;
    const viewMode = document.querySelector('#viewMode').value;
    const sortBy = document.querySelector('#sortBy').value;
    const groupBy = document.querySelector('#groupBy').value;
      const params = new URLSearchParams();
      if (q) params.set('q', q);
      if (autor) params.set('autor', autor);
      if (titulo) params.set('titulo', titulo);
      if (genre) params.set('genre', genre);
      if (year_from) params.set('year_from', year_from);
      if (year_to) params.set('year_to', year_to);
      if (stateFilter) params.set('state_filter', stateFilter);
      if (sortBy) params.set('sort_by', sortBy);
      params.set('page', state.page);
      params.set('page_size', state.page_size);
      return params.toString();
    }    // Rendering
    function escapeHtml(s){ return String(s ?? '').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
    
    function sortBooks(books, sortBy) {
      return [...books].sort((a, b) => {
        switch (sortBy) {
          case 'author': return a.author.localeCompare(b.author);
          case 'year': return (b.year || 0) - (a.year || 0);
          case 'added': return new Date(b.created_at || 0) - new Date(a.created_at || 0);
          case 'progress': return (b.progress_percent || 0) - (a.progress_percent || 0);
          case 'genre': return (a.genre || '').localeCompare(b.genre || '');
          default: return a.title.localeCompare(b.title);
        }
      });
    }
    
    function groupBooks(books, groupBy) {
      if (!groupBy) return { '': books };
      const groups = {};
      books.forEach(book => {
        let key = '';
        switch (groupBy) {
          case 'author': key = book.author || 'Sin autor'; break;
          case 'genre': key = book.genre || 'Sin g√©nero'; break;
          case 'year': key = book.year ? String(book.year) : 'Sin a√±o'; break;
        }
        if (!groups[key]) groups[key] = [];
        groups[key].push(book);
      });
      return groups;
    }
    
    function renderList(data) {
      state.total = data.total ?? 0; state.items = data.items || []; state.page = data.page ?? 1; state.page_size = data.page_size ?? 20;
      const list = document.querySelector('#list');
      const viewMode = document.querySelector('#viewMode').value;
      const sortBy = document.querySelector('#sortBy').value;
      const groupBy = document.querySelector('#groupBy').value;
      
      // Apply view mode class
      const resultsEl = document.querySelector('#results');
      resultsEl.classList.toggle('grid-view', viewMode === 'grid');
      
      // Sort and group
      const sortedBooks = sortBooks(state.items, sortBy);
      const groupedBooks = groupBooks(sortedBooks, groupBy);
      
      list.innerHTML = '';
      
      Object.keys(groupedBooks).forEach(groupKey => {
        if (groupKey && groupBy) {
          const header = document.createElement('div');
          header.className = 'group-header';
          header.textContent = groupKey;
          list.appendChild(header);
        }
        
  groupedBooks[groupKey].forEach(b => {
          const div = document.createElement('div'); 
          div.className = 'book';
          div.style.cursor = 'pointer';
          div.dataset.bookId = b.id;
          div.dataset.enrichmentStatus = b.enrichment_status || 'none';
          
          const sizeKB = b.size_bytes ? Math.max(1, Math.round(b.size_bytes/1024)) : '';
          const metaLine = [b.language, b.genre, (b.year || '')].filter(Boolean).join(' ‚Ä¢ ');
          const progressPercent = b.progress_percent || 0;
          const progressBar = progressPercent > 0 ? `<div class="progress-bar"><div class="progress-fill" style="width: ${progressPercent}%"></div></div>` : '';
          const readingTime = estimateReadingTime(b.id);
          const timeInfo = readingTime ? ` ‚Ä¢ ~${readingTime} restante` : '';
          
          const stateIcons = [];
          if (b.favorite) stateIcons.push('<span class="state-icon" title="Favorito">‚òÖ</span>');
          if (b.read) stateIcons.push('<span class="state-icon" title="Le√≠do">‚úì</span>');
          if (b.pending) stateIcons.push('<span class="state-icon" title="Pendiente">‚è≥</span>');
          if (bookmarks[b.id]?.length) stateIcons.push('<span class="state-icon" title="Con marcadores">üîñ</span>');
          if (notes[b.id]?.note) stateIcons.push('<span class="state-icon" title="Con notas">üìù</span>');
          
          const enrichedTags = b.tags ? b.tags.slice(0,4).map(tag => `<span class="chip">${escapeHtml(tag)}</span>`).join('') : '';
          
          let checkbox = '';
          if (batchMode) {
            checkbox = `<input type="checkbox" class="book-checkbox" ${selectedBooks.has(b.id) ? 'checked' : ''} onchange="toggleBookSelection(${b.id})">`;
          }
          
          const coverImg = `<img class="cover-img" src="${api(b.cover_url)}" alt="Portada" loading="lazy" onerror="this.style.display='none'">`;
          if (viewMode === 'grid') {
            div.innerHTML = `
              ${checkbox}
              <div class="book-cover">${coverImg}</div>
              <h4>${escapeHtml(b.title)} ${stateIcons.join('')}</h4>
              <div class="book-author">${escapeHtml(b.author)}</div>
              ${metaLine ? `<div class="book-meta">${escapeHtml(metaLine)}</div>` : ''}
              ${progressBar}
              ${enrichedTags ? `<div class="chips">${enrichedTags}</div>` : ''}`;
          } else {
            // Calcular tama√±o del archivo
            const sizeText = sizeKB ? `${sizeKB} KB` : '';
            const metaItems = [
              b.language ? `<span class="meta-item">üåê ${b.language}</span>` : '',
              b.genre ? `<span class="meta-item">üìö ${b.genre}</span>` : '',
              b.year ? `<span class="meta-item">üìÖ ${b.year}</span>` : '',
              sizeText ? `<span class="meta-item">üíæ ${sizeText}</span>` : '',
              readingTime ? `<span class="meta-item">‚è±Ô∏è ${readingTime} restante</span>` : ''
            ].filter(Boolean);
            
            const enrichmentIcon = b.enrichment_status === 'ok' ? '‚ú®' : 
                                  b.enrichment_status === 'failed' ? '‚ùå' : '‚≠ï';
            
            div.innerHTML = `
              ${checkbox}
              <div class="book-header">
                <div class="book-info">
                  <h4>${escapeHtml(b.title)} ${stateIcons.join('')}</h4>
                  <div class="book-author">üë§ ${escapeHtml(b.author)}</div>
                  ${metaItems.length ? `<div class="book-meta">${metaItems.join('<span class="meta-separator">‚Ä¢</span>')}</div>` : ''}
                </div>
                <div class="book-cover">${coverImg}</div>
              </div>
              ${progressBar}
              ${enrichedTags ? `<div class="chips">${enrichedTags}</div>` : ''}
              <div class="actions">
                <a class="action primary" href="${api(`/download/${b.id}`)}" target="_blank" rel="noopener">
                  <span class="action-icon">‚¨áÔ∏è</span> ${t('download')}
                </a>
                <button class="action" data-enrich="${b.id}">
                  <span class="action-icon">${enrichmentIcon}</span> ${t('enrich')}
                </button>
                <button class="action ghost" data-info="${b.id}">
                  <span class="action-icon">‚ÑπÔ∏è</span> Info
                </button>
              </div>`;
          }
          
          // Click anywhere on card to open book (unless in batch mode)
          if (!batchMode) {
            div.addEventListener('click', () => openBook(b.id));
          }
          list.appendChild(div);
        });
      });
      
      document.querySelector('#pageinfo').textContent =
        t('pageInfo', { page: state.page, pages: Math.max(1, Math.ceil(state.total/state.page_size)), total: state.total });
    }

  // Wrapper referenced in multiple places
  async function performSearch() { return search(); }

    // Batch Operations
    function toggleBatchMode() {
      batchMode = !batchMode;
      selectedBooks.clear();
      const batchBtn = document.querySelector('#batchBtn');
      batchBtn.textContent = batchMode ? 'Salir' : 'Lote';
      batchBtn.classList.toggle('active', batchMode);
      document.body.classList.toggle('batch-mode', batchMode);
      performSearch(); // Re-render to show/hide checkboxes
    }
    
    function toggleBookSelection(bookId) {
      if (selectedBooks.has(bookId)) {
        selectedBooks.delete(bookId);
      } else {
        selectedBooks.add(bookId);
      }
      updateBatchToolbar();
    }
    
    function selectAllBooks() {
      state.items.forEach(book => selectedBooks.add(book.id));
      updateBatchToolbar();
      document.querySelectorAll('.book-checkbox').forEach(cb => cb.checked = true);
    }
    
    function clearSelection() {
      selectedBooks.clear();
      updateBatchToolbar();
      document.querySelectorAll('.book-checkbox').forEach(cb => cb.checked = false);
    }
    
    function updateBatchToolbar() {
      const count = selectedBooks.size;
      const countEl = document.querySelector('#selectedCount');
      const batchActions = document.querySelector('#batchActions');
      countEl.textContent = count;
      batchActions.style.display = count > 0 ? 'flex' : 'none';
    }
    
    async function batchMarkFavorite() {
      if (selectedBooks.size === 0) return;
      try {
        for (let bookId of selectedBooks) {
          await setBookState(bookId, 'favorite', true);
        }
        clearSelection();
        await performSearch();
        showMessage('Marcados como favoritos');
      } catch (error) {
        console.error('Batch favorite error:', error);
        showMessage('Error al marcar favoritos', 'error');
      }
    }
    
    async function batchMarkRead() {
      if (selectedBooks.size === 0) return;
      try {
        for (let bookId of selectedBooks) {
          await setBookState(bookId, 'read', true);
        }
        clearSelection();
        await performSearch();
        showMessage('Marcados como le√≠dos');
      } catch (error) {
        console.error('Batch read error:', error);
        showMessage('Error al marcar le√≠dos', 'error');
      }
    }
    
    // Reading Time Estimation
    function estimateReadingTime(bookId) {
      const book = state.items.find(b => b.id === bookId);
      if (!book || !book.word_count) return null;
      
      const wordsPerMinute = 250; // Average reading speed
      const totalMinutes = book.word_count / wordsPerMinute;
      const progressPercent = book.progress_percent || 0;
      const remainingMinutes = totalMinutes * (1 - progressPercent / 100);
      
      if (remainingMinutes < 60) return `${Math.round(remainingMinutes)}min`;
      return `${Math.round(remainingMinutes / 60)}h`;
    }
    
    // Auto Night Mode
    function checkAutoNightMode() {
      if (autoNightMode) {
        const hour = new Date().getHours();
        const shouldBeNight = hour < 7 || hour > 20;
        if (shouldBeNight !== nightMode) {
          toggleNightMode();
        }
      }
    }
    
    function toggleNightMode() {
      nightMode = !nightMode;
      document.body.classList.toggle('night-mode', nightMode);
      localStorage.setItem('nightMode', nightMode);
    }
    
    // Bookmark Management
    function addBookmark(bookId, position, note = '') {
      if (!bookmarks[bookId]) bookmarks[bookId] = [];
      const bookmark = {
        id: Date.now(),
        position,
        note,
        timestamp: new Date().toISOString()
      };
      bookmarks[bookId].push(bookmark);
      saveBookmarks();
      return bookmark.id;
    }
    
    function removeBookmark(bookId, bookmarkId) {
      if (!bookmarks[bookId]) return;
      bookmarks[bookId] = bookmarks[bookId].filter(b => b.id !== bookmarkId);
      saveBookmarks();
    }
    
    function getBookmarks(bookId) {
      return bookmarks[bookId] || [];
    }
    
    function saveBookmarks() {
      localStorage.setItem('bookmarks', JSON.stringify(bookmarks));
    }
    
    function loadBookmarks() {
      const saved = localStorage.getItem('bookmarks');
      if (saved) {
        try {
          bookmarks = JSON.parse(saved);
        } catch (error) {
          console.error('Error loading bookmarks:', error);
          bookmarks = {};
        }
      }
    }
    
    // Notes Management
    function setNote(bookId, note) {
      if (!notes[bookId]) notes[bookId] = {};
      notes[bookId].note = note;
      notes[bookId].timestamp = new Date().toISOString();
      saveNotes();
    }
    
    function getNote(bookId) {
      return notes[bookId]?.note || '';
    }
    
    function saveNotes() {
      localStorage.setItem('notes', JSON.stringify(notes));
    }
    
    function loadNotes() {
      const saved = localStorage.getItem('notes');
      if (saved) {
        try {
          notes = JSON.parse(saved);
        } catch (error) {
          console.error('Error loading notes:', error);
          notes = {};
        }
      }
    }

    // Messages and notifications
    function showMessage(message, type = 'info') {
      // Create message element if it doesn't exist
      let messageEl = document.querySelector('#message-toast');
      if (!messageEl) {
        messageEl = document.createElement('div');
        messageEl.id = 'message-toast';
        messageEl.style.cssText = `
          position: fixed;
          top: 20px;
          right: 20px;
          background: var(--panel-solid);
          border: 1px solid var(--line);
          border-radius: 8px;
          padding: 1rem 1.5rem;
          box-shadow: 0 4px 16px rgba(0,0,0,0.1);
          z-index: 1000;
          transform: translateX(400px);
          transition: transform 0.3s ease;
          max-width: 300px;
        `;
        document.body.appendChild(messageEl);
      }
      
      // Set message and type
      messageEl.textContent = message;
      messageEl.className = `message-${type}`;
      
      // Add type-specific styling
      if (type === 'success') {
        messageEl.style.borderColor = '#34c759';
        messageEl.style.color = '#34c759';
      } else if (type === 'error') {
        messageEl.style.borderColor = '#ff3b30';
        messageEl.style.color = '#ff3b30';
      } else {
        messageEl.style.borderColor = 'var(--accent)';
        messageEl.style.color = 'var(--fg)';
      }
      
      // Show message
      messageEl.style.transform = 'translateX(0)';
      
      // Hide after 3 seconds
      setTimeout(() => {
        messageEl.style.transform = 'translateX(400px)';
      }, 3000);
    }

    // Interactions
    function setStatus(text) { document.querySelector('#status').textContent = text; }
    async function search() {
      const qs = buildQuery(); const url = api(`/books?${qs}`);
      setStatus(t('searching'));
      try { const data = await fetchJSON(url); renderList(data); setStatus(t('done')); }
      catch (e) { console.error(e); setStatus(`${t('error')}: ${e.message}`); }
    }
    async function openBook(id) {
        currentBookId = String(id);
      const reader = document.querySelector('#reader');
      setReaderHTML('<div class="meta">Cargando‚Ä¶</div>');
        try { const html = await fetchJSON(api(`/open/${id}`)); setReaderHTML(html); applyReaderPrefs(); } catch(e) { setReaderHTML(`<pre>${(e && e.message) || 'Error'}</pre>`); }
        try {
          const detail = await fetchJSON(api(`/books/${id}`));
          document.querySelector('#detail').textContent = `${detail.title} ‚Äî ${detail.author}`;
          // Reset page info suffix for new book
          lastDetailBase = `${detail.title} ‚Äî ${detail.author}`;
          updatePageInfo(true);
          // Update state toggles
          updateStateToggles(detail);
        } catch {}
        // Restore last position from server
        await restoreProgressServer();
      if (window.innerWidth < 1100) document.querySelector('.viewer').scrollIntoView({ behavior:'smooth', block:'start' });
    }
    async function enrich(id) {
      setStatus(t('enriching'));
      console.log('Enriching book ID:', id);
      
      // Encontrar la ficha del libro y a√±adir clase de carga
      const bookCard = document.querySelector(`[data-book-id="${id}"]`);
      if (bookCard) {
        bookCard.classList.add('enriching');
      }
      
      try { 
        const res = await fetchJSON(api(`/enrich/${id}`), { method: 'POST' }); 
        console.log('Enrich response:', res);
        setStatus(`${t('enriched')}: ${res.status ?? 'ok'}`); 
        await performSearch(); // Usar performSearch en lugar de search
        showMessage('Libro enriquecido correctamente', 'success');
      } catch(e) { 
        console.error('Enrich error:', e);
        setStatus(`${t('error')}: ${e.message}`); 
        showMessage(`Error al enriquecer: ${e.message}`, 'error');
      } finally {
        // Remover clase de carga
        if (bookCard) {
          bookCard.classList.remove('enriching');
        }
      }
    }

    // Enrich All / New
    let enrichPoll = null;
    async function pollEnrichStatus() {
      try {
        const s = await fetchJSON(api('/enrich/status'));
        if (s && s.running) {
          const total = s.total ?? 0, processed = s.processed ?? 0, ok = s.updated ?? 0, failed = s.failed ?? 0;
          setStatus(`${t('enrichingAll')} ${processed}/${total} ‚Ä¢ ok:${ok} ‚Ä¢ x:${failed}`);
        } else {
          if (s && s.total != null) {
            const total = s.total ?? 0, processed = s.processed ?? 0, ok = s.updated ?? 0, failed = s.failed ?? 0;
            setStatus(`${t('done')} ‚Ä¢ ${processed}/${total} ‚Ä¢ ok:${ok} ‚Ä¢ x:${failed}`);
          } else {
            setStatus(t('done'));
          }
          if (enrichPoll) { clearInterval(enrichPoll); enrichPoll = null; }
          await search();
        }
      } catch (e) { /* ignore transient errors */ }
    }
    async function enrichAll(opts) {
      setStatus(t('enrichingAll'));
      try {
        const res = await fetchJSON(api('/enrich/all'), {
          method: 'POST', headers: {'content-type':'application/json'},
          body: JSON.stringify({ only_pending: true, throttle_ms: 250, ...opts })
        });
        if (res && res.status === 'started') {
          setStatus(`${t('started')} ‚Ä¢ ${t('enrichingAll')}`);
          if (!enrichPoll) enrichPoll = setInterval(pollEnrichStatus, 30000); // 30 segundos
        } else if (res && res.status === 'already_running') {
          if (!enrichPoll) enrichPoll = setInterval(pollEnrichStatus, 30000); // 30 segundos
        } else {
          setStatus(t('done'));
        }
      } catch (e) {
        setStatus(`${t('error')}: ${e.message}`);
      }
    }

    // Events
    document.getElementById('btnSearch').addEventListener('click', () => { state.page = 1; const q = document.querySelector('#q').value.trim(); if (q) saveSearch(q); search(); });
    document.getElementById('prev').addEventListener('click', () => { if (state.page>1){ state.page--; search(); }});
    document.getElementById('next').addEventListener('click', () => { const max = Math.ceil(state.total/state.page_size); if (state.page<max){ state.page++; search(); }});
    document.getElementById('btnReindex').addEventListener('click', async () => {
      setStatus(t('reindexing'));
      try { await fetchJSON(api('/reindex'), { method:'POST', headers:{'content-type':'application/json'}, body: JSON.stringify({mode:'sync'}) });
        setStatus(t('reindexed')); search();
      } catch(e){ setStatus(`${t('error')}: ${e.message}`); }
    });
    document.getElementById('btnEnrichAll').addEventListener('click', async () => {
      enrichAll({ only_pending: true });
    });
    document.getElementById('btnEnrichNew').addEventListener('click', async () => {
      enrichAll({ only_never: true });
    });
    document.addEventListener('click', async (e) => {
      // Batch mode button
      if (e.target.id === 'batchBtn') {
        toggleBatchMode();
        return;
      }
      
      // Batch operations
      if (e.target.id === 'selectAllBtn') {
        selectAllBooks();
        return;
      }
      
      if (e.target.id === 'clearSelectionBtn') {
        clearSelection();
        return;
      }
      
      if (e.target.id === 'batchFavoriteBtn') {
        await batchMarkFavorite();
        return;
      }
      
      if (e.target.id === 'batchReadBtn') {
        await batchMarkRead();
        return;
      }
      
      // Book actions - buscar el elemento m√°s cercano con data attributes o enlaces de descarga
      const target = e.target.closest('button[data-enrich], button[data-info], a.action');
      if (target) {
        e.stopPropagation();
        e.preventDefault();
        
        console.log('Action clicked:', target);
        
        if (target.dataset.enrich) {
          console.log('Enriching book ID:', target.dataset.enrich);
          await enrich(parseInt(target.dataset.enrich));
        } else if (target.dataset.info) {
          console.log('Showing info for book ID:', target.dataset.info);
          await showBookInfo(parseInt(target.dataset.info));
        } else if (target.matches('a.action')) {
          // Para enlaces de descarga, permitir el comportamiento normal
          e.stopPropagation();
          // No preventDefault() para permitir la descarga
          window.open(target.href, '_blank', 'noopener');
          return;
        }
        return;
      }
    });
    document.addEventListener('keydown', (e)=>{
      if (['INPUT', 'SELECT'].includes(document.activeElement?.tagName)) {
        if (e.key === 'Enter') { e.preventDefault(); state.page = 1; const q = document.querySelector('#q').value.trim(); if (q) saveSearch(q); search(); }
        return;
      }
      // Global shortcuts
      if (e.key === ' ') { e.preventDefault(); const r = document.getElementById('reader'); if (r) r.scrollBy(0, r.clientHeight * 0.8); }
      if (e.key === 'f' || e.key === 'F') { e.preventDefault(); toggleFullscreen(); }
      if (readerPrefs.mode==='paged' && ['ArrowRight','PageDown'].includes(e.key)) { e.preventDefault(); pageNext(); }
      if (readerPrefs.mode==='paged' && ['ArrowLeft','PageUp'].includes(e.key)) { e.preventDefault(); pagePrev(); }
    });

    // Theme + language init
    document.getElementById('btn-theme-auto').addEventListener('click', ()=>setTheme('auto'));
    document.getElementById('btn-theme-light').addEventListener('click', ()=>setTheme('light'));
    document.getElementById('btn-theme-dark').addEventListener('click', ()=>setTheme('dark'));
    document.getElementById('lang').addEventListener('change', (e)=> setLang(e.target.value));

    initTheme();
    initLang();
    applyI18n();
    // Load filters then search (wrap async work to avoid top-level await)
    (async () => {
      try {
        const filters = await fetchJSON(api('/filters'));
        const selAutor = document.getElementById('autor');
        selAutor.innerHTML = `<option value="">${t('authorPlaceholder')}</option>` + (filters.authors||[]).map(a=>`<option value="${a}">${a}</option>`).join('');
        const selGenre = document.getElementById('genre');
        selGenre.innerHTML = `<option value="">${t('genrePlaceholder')}</option>` + (filters.genres||[]).map(g=>`<option value="${g}">${g}</option>`).join('');
        const selFrom = document.getElementById('year_from');
        const selTo = document.getElementById('year_to');
        const minY = filters.min_year ?? '';
        const curY = filters.current_year ?? new Date().getFullYear();
        let years = [];
        if (minY) { for (let y=curY; y>=minY; y--) years.push(y); }
        else { for (let y=curY; y>=1900; y--) years.push(y); }
        // Default empty options hinting the range, but with empty value to avoid filtering by default
        selFrom.innerHTML = `<option value="">${t('yearFromPlaceholder')}${minY?': '+minY:''}</option>` + years.slice().reverse().map(y=>`<option value="${y}">${y}</option>`).join('');
        selTo.innerHTML = `<option value="">${t('yearToPlaceholder')}${curY?': '+curY:''}</option>` + years.map(y=>`<option value="${y}">${y}</option>`).join('');
        selFrom.value = '';
        selTo.value = '';
      } catch(e) { /* ignore */ }
      // Always perform an initial search
      search();
      // Render history after initial load
      renderHistory();
    })();

  // -------- Reader controls --------
  const READER_PREFS_KEY = 'archive.reader';
  let readerPrefs = { mode: 'scroll', fontSize: 1.0, family: 'serif', lineHeight: 1.6, padding: 1.25 };
  let lastDetailBase = '‚Äî';
  let currentBookId = null;
  // Server-side progress
  async function getProgressServer(){ if (!currentBookId) return null; try { return await fetchJSON(api(`/books/${currentBookId}/progress`)); } catch { return null; } }
  async function setProgressServer(payload){ if (!currentBookId) return; try { await fetchJSON(api(`/books/${currentBookId}/progress`), { method:'POST', headers:{'content-type':'application/json'}, body: JSON.stringify(payload) }); } catch {} }
  function loadReaderPrefs(){ try { const s = JSON.parse(localStorage.getItem(READER_PREFS_KEY) || '{}'); readerPrefs = { ...readerPrefs, ...s }; } catch{} }
  function saveReaderPrefs(){ localStorage.setItem(READER_PREFS_KEY, JSON.stringify(readerPrefs)); }
  function applyReaderPrefs(){
    const r = document.getElementById('reader'); if (!r) return;
    r.style.setProperty('--reader-font-size', `${readerPrefs.fontSize}rem`);
    r.style.setProperty('--reader-line-height', String(readerPrefs.lineHeight));
    r.style.setProperty('--reader-family', readerPrefs.family);
    r.style.setProperty('--reader-padding', `${readerPrefs.padding}rem`);
    r.classList.toggle('page-mode', readerPrefs.mode==='paged');
    r.classList.toggle('scroll-mode', readerPrefs.mode!=='paged');
    // Show/hide page nav segment depending on mode
    const seg = document.getElementById('segPageNav');
    if (seg) seg.style.display = readerPrefs.mode==='paged' ? 'flex' : 'none';
    document.getElementById('btnModeScroll').classList.toggle('active', readerPrefs.mode!=='paged');
    document.getElementById('btnModePaged').classList.toggle('active', readerPrefs.mode==='paged');
  // Try to restore approximate position after visual changes
  // Try to restore approximate position after visual changes
  restoreProgressServer();
  updatePageInfo(true);
  }
  function setReaderHTML(html){ const r = document.getElementById('reader'); if (!r) return; r.innerHTML = html; r.scrollTop = 0; updatePageInfo(); }
  function pageNext(){ const r = document.getElementById('reader'); if (!r) return; const delta = r.clientHeight; r.scrollBy({ top: delta, behavior: 'smooth' }); setTimeout(updatePageInfo, 200); }
  function pagePrev(){ const r = document.getElementById('reader'); if (!r) return; const delta = r.clientHeight; r.scrollBy({ top: -delta, behavior: 'smooth' }); setTimeout(updatePageInfo, 200); }
  function updatePageInfo(reset=false){
    const r = document.getElementById('reader'); if (!r) return;
    const base = lastDetailBase || document.getElementById('detail').textContent.replace(/\s*‚Ä¢\s*P√°gina\s+\d+\/\d+$/, '');
    if (readerPrefs.mode !== 'paged') { document.getElementById('detail').textContent = base; return; }
    const total = Math.max(1, Math.ceil(r.scrollHeight / r.clientHeight));
    const current = Math.min(total, Math.max(1, Math.floor(r.scrollTop / r.clientHeight) + 1));
    document.getElementById('detail').textContent = `${base} ‚Ä¢ P√°gina ${current}/${total}`;
  }
  async function captureProgress(){
    if (!currentBookId) return;
    const r = document.getElementById('reader'); if (!r) return;
    const maxScroll = Math.max(1, r.scrollHeight - r.clientHeight);
    const percent = Math.max(0, Math.min(1, r.scrollTop / maxScroll));
    if (readerPrefs.mode === 'paged') {
      const total = Math.max(1, Math.ceil(r.scrollHeight / r.clientHeight));
      const current = Math.min(total, Math.max(1, Math.floor(r.scrollTop / r.clientHeight) + 1));
      await setProgressServer({ mode: 'paged', page: current, percent });
    } else {
      await setProgressServer({ mode: 'scroll', scroll_top: r.scrollTop, percent });
    }
  }
  async function restoreProgressServer(){
    if (!currentBookId) return;
    const r = document.getElementById('reader'); if (!r) return;
    const p = await getProgressServer();
    if (!p) return;
    if (readerPrefs.mode === 'paged' && p.page) {
      const page = Math.max(1, p.page|0);
      r.scrollTop = (page - 1) * r.clientHeight;
    } else if (readerPrefs.mode !== 'paged' && (typeof p.scroll_top === 'number' || typeof p.percent === 'number')) {
      const maxScroll = Math.max(0, r.scrollHeight - r.clientHeight);
      let target = typeof p.scroll_top === 'number' ? p.scroll_top : Math.round((p.percent || 0) * maxScroll);
      target = Math.max(0, Math.min(maxScroll, target));
      r.scrollTop = target;
    }
    updatePageInfo(true);
  }
  // Fullscreen toggle
  function toggleFullscreen(){
    const el = document.getElementById('viewerPanel');
    if (!document.fullscreenElement) {
      el.requestFullscreen?.();
    } else {
      document.exitFullscreen?.();
    }
  }
  
  // Book info modal
  function showBookInfo(bookId) {
    // Simple implementation - could be enhanced with a proper modal
    fetchJSON(api(`/books/${bookId}`)).then(book => {
      const enriched = book.enriched || {};
      const premise = enriched.premise || (enriched.localized?.es?.premise) || 'Sin descripci√≥n disponible';
      const tags = enriched.tags?.join(', ') || 'Sin etiquetas';
      const info = `
T√≠tulo: ${book.title}
Autor: ${book.author}
Idioma: ${book.language || 'N/A'}
G√©nero: ${book.genre || 'N/A'}
A√±o: ${book.year || 'N/A'}
Estado: ${book.read ? 'Le√≠do' : book.pending ? 'Pendiente' : book.favorite ? 'Favorito' : 'Sin marcar'}

Descripci√≥n: ${premise}

Etiquetas: ${tags}
      `.trim();
      alert(info); // Simple alert - could be replaced with a proper modal
    }).catch(() => alert('Error al cargar informaci√≥n del libro'));
  }
  
  // History breadcrumbs
  function renderHistory() {
    const header = document.querySelector('.wrap.nav');
    let historyDiv = document.getElementById('historyDiv');
    if (!historyDiv && recentBooks.length > 0) {
      historyDiv = document.createElement('div');
      historyDiv.id = 'historyDiv';
      historyDiv.className = 'history';
      historyDiv.innerHTML = '<span style="font-size: .75rem; color: var(--muted);">Reciente:</span>';
      header.appendChild(historyDiv);
    }
    if (historyDiv && recentBooks.length === 0) {
      historyDiv.remove();
      return;
    }
    if (historyDiv) {
      const items = recentBooks.slice(0, 5).map(book => 
        `<span class="history-item" onclick="openBook(${book.id})">${book.title}</span>`
      ).join('');
      historyDiv.innerHTML = `<span style="font-size: .75rem; color: var(--muted);">Reciente:</span> ${items}`;
    }
  }
  // Buttons
  document.getElementById('btnModeScroll').addEventListener('click', ()=>{ readerPrefs.mode='scroll'; saveReaderPrefs(); applyReaderPrefs(); });
  document.getElementById('btnModePaged').addEventListener('click', ()=>{ readerPrefs.mode='paged'; saveReaderPrefs(); applyReaderPrefs(); });
  document.getElementById('btnFontPlus').addEventListener('click', ()=>{ readerPrefs.fontSize = Math.min(2.0, +(readerPrefs.fontSize + 0.1).toFixed(2)); saveReaderPrefs(); applyReaderPrefs(); });
  document.getElementById('btnFontMinus').addEventListener('click', ()=>{ readerPrefs.fontSize = Math.max(0.7, +(readerPrefs.fontSize - 0.1).toFixed(2)); saveReaderPrefs(); applyReaderPrefs(); });
  document.getElementById('fontFamily').addEventListener('change', (e)=>{ readerPrefs.family = e.target.value; saveReaderPrefs(); applyReaderPrefs(); });
  document.getElementById('btnPageNext').addEventListener('click', pageNext);
  document.getElementById('btnPagePrev').addEventListener('click', pagePrev);
  document.getElementById('btnFullscreen').addEventListener('click', toggleFullscreen);
  document.getElementById('reader').addEventListener('scroll', ()=>{ captureProgress(); if (readerPrefs.mode==='paged') updatePageInfo(); });
  // Disable wheel scroll in paged mode, use it for page navigation
  document.getElementById('reader').addEventListener('wheel', (e)=>{
    if (readerPrefs.mode==='paged') { e.preventDefault(); if (e.deltaY > 0) pageNext(); else if (e.deltaY < 0) pagePrev(); }
  }, { passive: false });
  document.addEventListener('keydown', (e)=>{ if (readerPrefs.mode==='paged' && ['ArrowRight','PageDown'].includes(e.key)) { e.preventDefault(); pageNext(); } if (readerPrefs.mode==='paged' && ['ArrowLeft','PageUp'].includes(e.key)) { e.preventDefault(); pagePrev(); } });
  // Double click for fullscreen
  document.getElementById('reader').addEventListener('dblclick', toggleFullscreen);
  
  loadReaderPrefs(); applyReaderPrefs();
  loadHistory(); loadSearchHistory();

  // ---------- State toggles (favorite/read/pending) ----------
  async function updateStateToggles(detail){
    const bar = document.querySelector('.controls-row');
    let group = document.getElementById('stateGroup');
    if (!group) {
      group = document.createElement('div'); group.className = 'seg'; group.id = 'stateGroup'; group.setAttribute('role','group'); group.setAttribute('aria-label','Estado');
      group.innerHTML = `
        <button id="btnFav" title="Favorito">‚òÖ</button>
        <button id="btnRead" title="Le√≠do">‚úî</button>
        <button id="btnPending" title="Pendiente">‚è≥</button>
      `;
      bar.appendChild(group);
      document.getElementById('btnFav').addEventListener('click', async ()=>{ if (!currentBookId) return; const cur = group.classList.contains('is-fav'); await fetchJSON(api(`/books/${currentBookId}/state`), { method:'POST', headers:{'content-type':'application/json'}, body: JSON.stringify({ favorite: !cur }) }); group.classList.toggle('is-fav', !cur); await search(); });
      document.getElementById('btnRead').addEventListener('click', async ()=>{ if (!currentBookId) return; const cur = group.classList.contains('is-read'); await fetchJSON(api(`/books/${currentBookId}/state`), { method:'POST', headers:{'content-type':'application/json'}, body: JSON.stringify({ read: !cur }) }); group.classList.toggle('is-read', !cur); await search(); });
      document.getElementById('btnPending').addEventListener('click', async ()=>{ if (!currentBookId) return; const cur = group.classList.contains('is-pending'); await fetchJSON(api(`/books/${currentBookId}/state`), { method:'POST', headers:{'content-type':'application/json'}, body: JSON.stringify({ pending: !cur }) }); group.classList.toggle('is-pending', !cur); await search(); });
    }
    group.classList.toggle('is-fav', !!detail.favorite);
    group.classList.toggle('is-read', !!detail.read);
    group.classList.toggle('is-pending', !!detail.pending);
  }

  // Initialize app
  async function init() {
    loadBookmarks();
    loadNotes();
    
    // Load saved preferences
    const savedNightMode = localStorage.getItem('nightMode');
    if (savedNightMode) {
      nightMode = savedNightMode === 'true';
      document.body.classList.toggle('night-mode', nightMode);
    }
    
    // Check auto night mode
    checkAutoNightMode();
    setInterval(checkAutoNightMode, 60000); // Check every minute
    
    await loadFilters();
    await performSearch();
    setInterval(loadRecentHistory, 30000); // Update history every 30s
  }

  // Start the app
  document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>